{% extends "auctions/layout.html" %}

{% load custom_filters %}

{% load static %}

{% block title %}
    All Listings
{% endblock %}

{% block script %}
    <script src="{% static 'auctions/javascript/sort.js' %}" defer></script>
    <script src="{% static 'auctions/javascript/expand.js' %}" defer></script>
{% endblock %}

{% block navbar %}
    <li class="nav-item">
        <a class="nav-link" href="{% url 'index' %}">Active Listings</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'create' %}">Create Listing</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'watchlist' %}">Watchlist</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'categories' %}">All Categories</a>
    </li>
        <li class="nav-item">
        <a class="nav-link" href="{% url 'messages' current_user.id %}">Messages</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'profile' current_user.id %}">My Yard</a>
    </li>
{% endblock %}

{% block body %}
<div class="page-content">
    <h1 class="page-heading-h1">All Listings</h1>
    <div class="full-or-title">
        <p>
            <span class="full-listings opt-selected">Show Full Listings</span>
            ||
            <span class="title-only opt-not-selected ">Show Title Only</span>
        </p>
    </div>
    <p></p>

    <h3 id="active-listings" class="active-listings-heading">Active Listings</h3>
    <h6 id="go-to-closed">(go to closed listings)</h6>
    <form
        class="sort-by-form"
        action="{% url 'sort' %}"
        method="post"
    >
        {% csrf_token %}
        <input type="hidden" name="sort-by" id="sort-by" value="" />
        <input
        type="hidden"
        name="sort-by-direction"
        id="sort-by-direction"
        value=""
        />
        <input type="hidden" name="page" id="page" value="listings"/>
    </form>


    <div class="sort-by-container">
        <p class="sort-by-option" data-sort-by="title">Title</p>
        <p class="sort-by-option" data-sort-by="seller">Seller</p>
        <p class="sort-by-option" data-sort-by="date">Listing Date</p>
        <p class="sort-by-option" data-sort-by="price">Price</p>
    </div>
    <ul class="long-listings visible">
        {% for listing in listings %}
            
            {% if listing.active == True %}
            <div class="li-listing-div hide-listing">
                <li class="li-listing">
                    <div class="thumb-title-div">
                        <a href="{% url 'listing' listing.id %}">
                            {% if listing.image != "" %}
                                <div class="thumb-div">
                                    <img class="thumb-img" src="{{ listing.image }}">
                                </div>
                            {% else %}
                                <div class="thumb-div">
                                    <img class="thumb-img" src="{% static 'images/No_Image_Available.jpg' %}">
                                </div>
                            {% endif %}
                        </a>
                        <div class="list-desc-div">
                            <a class="big-a bold" href="{% url 'listing' listing.id %}">{{ listing.title }}</a>
                            <p>
                                <span class="bold">Current Bid:&nbsp; </span>{% with formatted_currency=listing.price|format_currency %}{{ formatted_currency }}{% endwith %}</br>
                                <div class="full-description visible">
                                    <span class="bold">Description:&nbsp; </span> {{ listing.description }}</br>
                                </div>
                                <div class="truncated-description hidden">
                                    <span class="bold">Description:&nbsp; </span> <span class="expand-link">{{ listing.description|truncatechars:125 }}</span></br>
                                </div>
                                {% if current_user.is_authenticated %}
                                        <span class="bold">Seller:&nbsp; </span> <a class="small-a" href="{% url 'profile' listing.user.id %}">{{ listing.user.username }}</a></br>
                                        {% with time_left_and_status=listing.id|get_time_left %}
                                            <span class="{{ time_left_and_status.1 }}">{{ time_left_and_status.0 }}</span></br>
                                        {% endwith %} 
                                {% endif %}
                            </p>    
                        </div>

                    </div>

                </li>
                <hr>
            </br>
            </div>
            {% endif %}
        {% endfor %}
    </ul>
    <div class="center-container"><span id="show-more" style="margin-bottom:40px;"></span></div>

    <ul class="short-listings hidden">
        {% for listing in listings %}
            {% if listing.active == True %}
                <li class="title-only-li" style="margin-bottom: 8px">
                    <a class="little-links" href="{% url 'listing' listing.id %}">{{ listing.title }}</a> -- {% with formatted_currency=listing.price|format_currency %}{{ formatted_currency }}{% endwith %} -- <a class="little-links" href="{% url 'profile' listing.user.id %}">{{ listing.user.username }}</a>
                </li>
            {% endif %}
        {% endfor %}
    </ul>

    <h3 id="closed-listings" class="page-heading-h3">Closed Listings</h3>
    <form
        class="sort-by-form"
        action="{% url 'sort' %}"
        method="post"
    >
        {% csrf_token %}
        <input type="hidden" name="sort-by" id="sort-by" value="" />
        <input
        type="hidden"
        name="sort-by-direction"
        id="sort-by-direction"
        value=""
        />
    </form>


    <div class="sort-by-container">
        <p class="sort-by-option" data-sort-by="title">Title</p>
        <p class="sort-by-option" data-sort-by="seller">Seller</p>
        <p class="sort-by-option" data-sort-by="date">Listing Date</p>
        <p class="sort-by-option" data-sort-by="price">Price</p>
    </div>
    <ul class="long-listings visible">
        {% for listing in listings %}
            {% if listing.active == False %}
            <div class="li-listing-closed-div hide-listing">
                <li class="li-listing">
                    <div class="thumb-title-div">
                        <a href="{% url 'listing' listing.id %}">
                            {% if listing.image != "" %}
                                <div class="thumb-div">
                                    <img class="thumb-img" src="{{ listing.image }}">
                                </div>
                            {% else %}
                                <div class="thumb-div">
                                    <img class="thumb-img" src="{% static 'images/No_Image_Available.jpg' %}">
                                </div>
                            {% endif %}
                        </a>
                        <div class="list-desc-div">
                            <a class="big-a bold" href="{% url 'listing' listing.id %}">{{ listing.title }}</a>
                            <p>
                                <span class="bold">Final Bid:&nbsp; </span>{% with formatted_currency=listing.price|format_currency %}{{ formatted_currency }}{% endwith %}</br>
                                    {% if listing.winner %}
                                        <span class="bold">Winner:&nbsp; {{ listing.winner.username }}</span></br>
                                    {% endif %}
                                <span class="bold">Seller:&nbsp; </span> <a class="small-a" href="{% url 'profile' listing.user.id %}">{{ listing.user.username }}</a>
                            </p>   
                        </div>
                    </div>
                </li>
                <hr>
            </br>
            </div>
            {% endif %}

        {% endfor %}
    </ul>
        <div class="center-container"><span id="show-more-closed">Show next 25 closed listings</span></div>
    <ul class="short-listings hidden">
        {% for listing in listings %}
            {% if listing.active == False %}
                <li class="title-only-li" style="margin-bottom: 8px">
                    <a class="little-links" href="{% url 'listing' listing.id %}">{{ listing.title }}</a> -- {% with formatted_currency=listing.price|format_currency %}{{ formatted_currency }}{% endwith %} -- <a class="little-links" href="{% url 'profile' listing.user.id %}">{{ listing.user.username }}</a>
                </li>
            {% endif %}
        {% endfor %}
    </ul>
    <p><span id="back-to-top">Back to top</span></p>
</div>
{% endblock %}