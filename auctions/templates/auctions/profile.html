{% extends "auctions/layout.html" %}

{% block title %}
    {{ user.username }}'s Profile
{% endblock %}

{% block navbar %}
    <li class="nav-item">
        <a class="nav-link" href="{% url 'index' %}">Active Listings</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'listings' %}">All Listings</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'create' %}">Create Listing</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'watchlist' %}">Watchlist</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'categories' %}">All Categories</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'messages' current_user.id %}">Messages</a>
    </li>
    {% if current_user != user %}
    <li class="nav-item">
        <a class="nav-link" href="{% url 'profile' current_user.id %}">My Yard</a>
    </li>
    {% endif %}

{% endblock %}

{% block body %}
<div>
    <form id="send-usr-msg-form" class="hidden-hero" action="{% url 'messages' current_user.id %}" method="post">
        {% csrf_token %}
        <div class="send-usr-msg-form-div">
            <input type="hidden" name="recipient" value="{{ user.id }}">
            <input class="form-control" type="text" name="subject" placeholder="Subject">
            <textarea class="form-control" name="message" placeholder="Message"></textarea>
            <button class="btn btn-primary" type="submit">Send</button>
            <button class="btn btn-primary" type="button" id="cancel-usr-msg">Cancel</button>
        </div>
    </form>
</div>
<div class="profile-page-content">
    <h1>{{ user.username }}'s Yard</h1>
    {% if user != current_user %}
        {% if current_user.is_authenticated %}
            <div class="send-msg-div center-container">
                <button id="send-usr-msg-btn" class="btn btn-primary">Send Message</button>
            </div>

            
        {% endif %}
    {% endif %}
    <p></p>
    <h2>Information</h2>
    <div class="profile-info">
        <ul>
            <li>Username: {{ user.username }}</li>
            <li>Email: {{ user.email }}</li>
            <li>First Name: {{ user.first_name }}</li>
            <li>Last Name: {{ user.last_name }}</li>
            <li>Joined: {{ user.date_joined }}</li>
        </ul>
    {% if current_user == user %}
            <button id="edit-button" class="btn btn-primary">Edit Profile</button>
            <button id="change-password" class="btn btn-primary">Change Password</button>
            
        </div>

        <div id="edit-profile" class="hidden-form">
            <form class="popup-form" action="{% url 'edit' current_user.id %}" method="post">
                {% csrf_token %}
                {{ user_info_form }}
                <button class="btn btn-primary" type="submit" style="align-self:center">Save Changes</button>
                <button class="btn btn-primary" type="button" id="cancel-button" style="align-self:center">Cancel</button>
            </form>
        </div>

        <div id="change-password-form" class="hidden-form">
            <form class="popup-form" action="{% url 'change_password' current_user.id %}" method="post">
                {% csrf_token %}
                <input class="form-control" type="password" name="old_password" placeholder="Old Password">
                <input class="form-control" type="password" name="new_password1" placeholder="New Password">
                <input class="form-control" type="password" name="new_password2" placeholder="Confirm New Password">
                <button class="btn btn-primary" type="submit" style="align-self:center">Change Password</button>
                <button class="btn btn-primary" type="button" id="cancel-password" style="align-self:center">Cancel</button>
            </form>
        </div>
        <div class="profile-listings">
            <hr>
        </div>
        <div class="account-balance">
            <h2>Account Balance</h2>
            <p>${{ current_user.balance }}</p>
            <p><a href="{% url 'transactions' current_user.id %}">View Transaction History</a></p>
            <button id="deposit-btn" class="btn btn-primary">Deposit Funds</button>
            <button id="withdraw-btn" class="btn btn-primary">Withdraw Funds</button>
        </div>
        <div class="deposit-form hidden-form">
            <form class="popup-form" action="{% url 'deposit' current_user.id %}" method="post">
                {% csrf_token %}
                <h3>Deposit Funds</h3>
                <input class="form-control" type="number" name="amount" placeholder="Amount">
                <button class="btn btn-primary" type="submit" style="align-self:center">Deposit</button>
                <button class="btn btn-primary" type="button" id="cancel-deposit" style="align-self:center">Cancel</button>
            </form>
        </div>
        <div class="withdraw-form hidden-form">
            <form class="popup-form" action="{% url 'withdraw' current_user.id %}" method="post">
                {% csrf_token %}
                <h3>Withdraw Funds</h3>
                <input class="form-control" type="number" name="amount" placeholder="Amount">
                <button class="btn btn-primary" type="submit" style="align-self:center">Withdraw</button>
                <button class="btn btn-primary" type="button" id="cancel-withdraw" style="align-self:center">Cancel</button>
            </form>
        </div>
    {% endif %}
    <p></p>
    <div class="profile-listings">
        <hr>
    </div>

    {% if user == current_user %}
        <h2>My Active Listings</h2>
    {% else %}
        <h2>{{ user.username }}'s Active Listings</h2>
    {% endif %}
    
    <div class="profile-listings">
        {% if user.listings.all.count == 0 %}
            <div class="center-container">
                <p>No active listings. <a href="{% url 'create' %}">Want to change that?</a></p>
            </div>
        {% endif %}
        <ul>
            {% for listing in user.listings.all %}
                {% if listing.active == True %}
                    <li class="li-listing">  
                        <a class="bold" href="{% url 'listing' listing.id %}">{{ listing.title }}</a>
                    </li>
                {% endif %}
            {% endfor %}
        </ul>
        <hr style="margin-top:30px;">
    </div>  

    {% if user == current_user %}
        <h2>My Closed Listings</h2>
    {% else %}
        <h2>{{ user.username }}'s Closed Listings</h2>
    {% endif %}

    <div id="profile-closed-listings" class="profile-listings">
        <ul>
            {% for listing in user.listings.all %}
                {% if listing.active == False %}
                    <li class="li-listing">
                            <a class="bold" href="{% url 'listing' listing.id %}">{{ listing.title }}</a>
                    </li>
                    {% if listing.price == listing.starting_bid %}
                        <p style="display:inline" class="bold">No bids</p>
                    {% else %}
                    <p style="display:inline"><span class="bold">Final Bid:</span> {{ listing.price }}</br>
                        {% for winner in winners %}
                            {% if winner.listing == listing %}
                                <span class="bold">Winner:</span> {{ winner.user.username }}
                            {% elif forloop.last %}
                                No winner
                            {% endif %}
                        {% endfor %}
                    </p>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </ul>
    </div>
</div>

<script>
    const sendMsgButton = document.getElementById('send-usr-msg-btn');
    const sendMsgForm = document.getElementById('send-usr-msg-form');
    const cancelMsg = document.getElementById('cancel-usr-msg');

    sendMsgButton.addEventListener('click', () => {
        sendMsgForm.classList.remove('hidden-hero');
        sendMsgForm.classList.add('visible-hero');
    });

    cancelMsg.addEventListener('click', () => {
        sendMsgForm.classList.add('hidden-hero');
        sendMsgForm.classList.remove('visible-hero');
    });


    const depositButton = document.getElementById('deposit-btn');
    const depositForm = document.querySelector('.deposit-form');
    const cancelDeposit = document.getElementById('cancel-deposit');

    depositButton.addEventListener('click', () => {
        depositForm.classList.remove('hidden-form');
        depositForm.classList.add('visible-form');
    });

    cancelDeposit.addEventListener('click', () => {
        depositForm.classList.add('hidden-form');
        depositForm.classList.remove('visible-form');
    });

    const withdrawButton = document.getElementById('withdraw-btn');
    const withdrawForm = document.querySelector('.withdraw-form');
    const cancelWithdraw = document.getElementById('cancel-withdraw');

    withdrawButton.addEventListener('click', () => {
        withdrawForm.classList.remove('hidden-form');
        withdrawForm.classList.add('visible-form');
    });

    cancelWithdraw.addEventListener('click', () => {
        withdrawForm.classList.add('hidden-form');
        withdrawForm.classList.remove('visible-form');
    });


    const editButton = document.getElementById('edit-button');
    const editProfile = document.getElementById('edit-profile');
    const cancelButton = document.getElementById('cancel-button');

    editButton.addEventListener('click', () => {
        editProfile.classList.remove('hidden-form');
        editProfile.classList.add('visible-form');
    });

    cancelButton.addEventListener('click', () => {
        editProfile.classList.add('hidden-form');
        editProfile.classList.remove('visible-form');
    });

    const changePassword = document.getElementById('change-password');
    const changePasswordForm = document.getElementById('change-password-form');
    const cancelPassword = document.getElementById('cancel-password');

    changePassword.addEventListener('click', () => {
        changePasswordForm.classList.remove('hidden-form');
        changePasswordForm.classList.add('visible-form');
    });

    cancelPassword.addEventListener('click', () => {
        changePasswordForm.classList.add('hidden-form');
        changePasswordForm.classList.remove('visible-form');
    });
</script>

{% endblock %}