{% extends "auctions/layout.html" %}

{% block title %}
    {{ user.username }}'s Profile
{% endblock %}

{% block navbar %}
    <li class="nav-item">
        <a class="nav-link" href="{% url 'index' %}">Active Listings</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'listings' %}">All Listings</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'create' %}">Create Listing</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'watchlist' %}">Watchlist</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'categories' %}">All Categories</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'logout' %}">Log Out</a>
    </li>
{% endblock %}

{% block body %}
<h1>{{ user.username }}'s Yard</h1>

<div class="profile-info">
    <h2>Information</h2>
    <ul>
        <li>Username: {{ user.username }}</li>
        <li>Email: {{ user.email }}</li>
        <li>First Name: {{ user.first_name }}</li>
        <li>Last Name: {{ user.last_name }}</li>
        <li>Joined: {{ user.date_joined }}</li>
    </ul>
    {% if current_user == user %}
        <p>Change your profile information or password below.</p>
    <button id="edit-button">Edit Profile</button>
    <button id="change-password">Change Password</button>
    
</div>

<div id="edit-profile" class="hidden-form">
    <form action="{% url 'edit' user.id %}" method="post">
        {% csrf_token %}
        {{ user_info_form.as_p }}
        <input type="submit" value="Save">
        <button type="button" id="cancel-button">Cancel</button>
    </form>
</div>

<div id="change-password-form" class="hidden-form">
    <form action="{% url 'change_password' user.id %}" method="post">
        {% csrf_token %}
        <input type="password" name="old_password" placeholder="Old Password">
        <input type="password" name="new_password1" placeholder="New Password">
        <input type="password" name="new_password2" placeholder="Confirm New Password">
        <input type="submit" value="Change Password">
        <button type="button" id="cancel-password">Cancel</button>
    </form>
</div>
{% endif %}
<div class="profile-listings">
    <h2>Active Listings</h2>
    <ul>
        {% for listing in user.listings.all %}
            {% if listing.active == True %}
                <li class="li-listing">  
                    <a class="title-link" href="{% url 'listing' listing.id %}">{{ listing.title }}</a>
                </li>
            {% endif %}
        {% endfor %}
    </ul>
    <h2>Closed Listings</h2>
    <ul>
        {% for listing in user.listings.all %}
            {% if listing.active == False %}
                <li class="li-listing">
                    <div class="thumb-title-div">
                        {% if listing.image != "" %}
                        <div class="thumb-div">
                            <img src="{{ listing.image }}" height="100">
                        </div>
                        {% endif %}
                        <a class="title-link" href="{% url 'listing' listing.id %}">{{ listing.title }}</a>
                </li>
                {% if listing.price == listing.starting_bid %}
                    <p>No bids</p>
                {% else %}
                <p>Final Bid: {{ listing.price }}</br>
                    {% for winner in winners %}
                        {% if winner.listing == listing %}
                            Winner: {{ winner.user.username }}
                        {% elif forloop.last %}
                            No winner
                        {% endif %}
                    {% endfor %}
                </p>
                {% endif %}
            {% endif %}
        {% endfor %}
    </ul>
</div>


<script>
    const editButton = document.getElementById('edit-button');
    const editProfile = document.getElementById('edit-profile');
    const cancelButton = document.getElementById('cancel-button');

    editButton.addEventListener('click', () => {
        editProfile.classList.remove('hidden-form');
        editProfile.classList.add('visible-form');
    });

    cancelButton.addEventListener('click', () => {
        editProfile.classList.add('hidden-form');
        editProfile.classList.remove('visible-form');
    });

    const changePassword = document.getElementById('change-password');
    const changePasswordForm = document.getElementById('change-password-form');
    const cancelPassword = document.getElementById('cancel-password');

    changePassword.addEventListener('click', () => {
        changePasswordForm.classList.remove('hidden-form');
        changePasswordForm.classList.add('visible-form');
    });

    cancelPassword.addEventListener('click', () => {
        changePasswordForm.classList.add('hidden-form');
        changePasswordForm.classList.remove('visible-form');
    });
</script>

{% endblock %}