{% extends "auctions/layout.html" %}

{% load custom_filters %}

{% block title %}
    {{ user.username }}'s Profile
{% endblock %}

{% block navbar %}
    <li class="nav-item">
        <a class="nav-link" href="{% url 'index' %}">Active Listings</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'listings' %}">All Listings</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'create' %}">Create Listing</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'watchlist' %}">Watchlist</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'categories' %}">All Categories</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'messages' current_user.id %}">Messages</a>
    </li>
    {% if current_user != user %}
    <li class="nav-item">
        <a class="nav-link" href="{% url 'profile' current_user.id %}">My Yard</a>
    </li>
    {% endif %}

{% endblock %}

{% block body %}
<div>
    <form id="send-usr-msg-form" class="hidden" action="{% url 'messages' current_user.id %}" method="post">
        {% csrf_token %}
        <div class="send-usr-msg-form-div">
            <h4 class="form-title">Message {{ user.username }}</h4>
            <input type="hidden" name="recipient" value="{{ user.id }}">
            <input class="form-control" type="text" name="subject" placeholder="Subject">
            <textarea class="form-control" name="message" placeholder="Message"></textarea>
            <div class="form-btn-box">
                <button class="btn btn-primary" type="submit">Send</button>
                <button class="btn btn-primary cancel-btn" type="button" id="cancel-usr-msg">Cancel</button>
            </div>
        </div>
    </form>
</div>
<div class="profile-page-content">
    <h1>{{ user.username }}'s Yard</h1>
    {% if user != current_user %}
        {% if current_user.is_authenticated %}
            <div class="send-msg-div center-container">
                <button id="send-usr-msg-btn" class="btn btn-primary">Send Message</button>
            </div>

            
        {% endif %}
    {% endif %}
    <p></p>
    <h2>Information</h2>
    <div class="profile-info">
        <ul>
            <li>Username: {{ user.username }}</li>
            <li>Email: {{ user.email }}</li>
            <li>First Name: {{ user.first_name }}</li>
            <li>Last Name: {{ user.last_name }}</li>
            <li>Joined: {{ user.date_joined }}</li>
        </ul>
    {% if current_user == user %}
            <button id="edit-button" class="btn btn-primary">Edit Profile</button>
            <button id="change-password" class="btn btn-primary">Change Password</button>
            
        </div>

        <div id="edit-profile" class="hidden">
            <form class="popup-form" action="{% url 'edit' current_user.id %}" method="post">
                {% csrf_token %}
                <h4 class="form-title">Edit Profile</h4>
                {{ user_info_form }}
                <div class="form-btn-box">
                    <button class="btn btn-primary" type="submit" style="align-self:center">Save Changes</button>
                    <button class="btn btn-primary cancel-btn" type="button" id="cancel-edit-profile-button" style="align-self:center">Cancel</button>
                </div>
            </form>
        </div>

        <div id="change-password-form" class="hidden">
            <form class="popup-form" action="{% url 'change_password' current_user.id %}" method="post">
                {% csrf_token %}
                <h4 class="form-title">Change Password</h4>
                <input class="form-control" type="password" name="old_password" placeholder="Old Password">
                <input class="form-control" type="password" name="new_password1" placeholder="New Password">
                <input class="form-control" type="password" name="new_password2" placeholder="Confirm New Password">
                <div class="form-btn-box">
                    <button class="btn btn-primary" type="submit" style="align-self:center">Change Password</button>
                    <button class="btn btn-primary cancel-btn" type="button" id="cancel-password-btn" style="align-self:center">Cancel</button>
                </div>
            </form>
        </div>
        <div class="profile-listings">
            <hr>
        </div>

        <div class="account-balance">
            <h2>Account Balance</h2>
            <p>{% with formatted_currency=current_user.balance|format_currency %}{{ formatted_currency }}{% endwith %}</p>
            <p><a id="transaction-history-link" href="{% url 'transactions' current_user.id %}">View Transaction History</a></p>
            <button id="deposit-btn" class="btn btn-primary">Deposit Funds</button>
            <button id="withdraw-btn" class="btn btn-primary">Withdraw Funds</button>
        </div>

        <div class="deposit-form hidden">
            <form class="popup-form" action="{% url 'deposit' current_user.id %}" method="post">
                {% csrf_token %}
                <h4 class="form-title">Deposit Funds</h4>
                <input class="form-control" type="number" name="amount" placeholder="Amount">
                <div class="form-btn-box">
                    <button class="btn btn-primary" type="submit" style="align-self:center">Deposit</button>
                    <button class="btn btn-primary cancel-btn" type="button" id="cancel-deposit-btn" style="align-self:center">Cancel</button>
                </div>
            </form>
        </div>
        <div class="withdraw-form hidden">
            <form class="popup-form" action="{% url 'withdraw' current_user.id %}" method="post">
                {% csrf_token %}
                <h4 class="form-title">Withdraw Funds</h4>
                <input class="form-control" type="number" name="amount" placeholder="Amount">
                <div class="form-btn-box">
                    <button class="btn btn-primary" type="submit" style="align-self:center">Withdraw</button>
                    <button class="btn btn-primary cancel-btn" type="button" id="cancel-withdraw-btn" style="align-self:center">Cancel</button>
                </div>
            </form>
        </div>
    {% endif %}
    <p></p>
    <div class="profile-listings">
        <hr>
    </div>
    {% if current_user == user %}
    <div class="user-bids">
        <h2>My Bids</h2>
        <p class="center-container"><a id="bid-history-link" href="{% url 'transactions' current_user.id %}">View Bidding History</a></p>
        <div class="center-container">
            <ul class="no-list-style-center">
            {% for bid_info in bid_info_list %}
                {% if bid_info.is_old_bid == True %}
                {% else %}
                <li class="li-listing">
                
                    {% if bid_info.user_bid.listing.active == True %}
                        <a class="bold" href="{% url 'listing' bid_info.user_bid.listing.id %}">{{ bid_info.user_bid.listing.title }}</a>
                            <p>
                                {% if bid_info.user_bid.amount == bid_info.highest_bid %}
                                    <span class="bold">Bid:</span> {% with formatted_currency=bid_info.user_bid.amount|format_currency %}{{ formatted_currency }}{% endwith %} <span class="green">(current highest bid)</span></br>
                                {% else %}
                                    <span class="bold">Bid:</span> {% with formatted_currency=bid_info.user_bid.amount|format_currency %}{{ formatted_currency }}{% endwith %} <span class="red">({% with formatted_currency=bid_info.difference|format_currency %}{{ formatted_currency }}{% endwith %} less than highest bid) </span></br>
                                {% endif %}
                            {% with time_left_and_status=bid_info.user_bid.listing.id|get_time_left %}
                                <span class="{{ time_left_and_status.1 }} dynamic-time-left-text">{{ time_left_and_status.0 }}</span>
                            {% endwith %} 
                        </p>
                    {% else %}
                        <div class="expired-bid">
                            <a class="bold" href="{% url 'listing' bid_info.user_bid.listing.id %}">{{ bid_info.user_bid.listing.title }}</a>
                            {% if bid_info.user_bid == bid_info.highest_bid %}
                                <p><span class="bold">Bid: </span>{% with formatted_currency=bid_info.user_bid.amount|format_currency %}{{ formatted_currency }}{% endwith %} <span class="green">(You Won!)</span></p>
                            {% else %}
                                <p>
                                <span class="bold">Bid: </span>{% with formatted_currency=bid_info.user_bid.amount|format_currency %}{{ formatted_currency }}{% endwith %} <span class="red">({{ bid_info.user_bid.listing.winner.username }} won this auction)</span>
                                </br>
                                <span>This auction has ended</span>
                                </p>
                            {% endif %}
                                
                        </div>
                    {% endif %}
                </li>
                {% endif %}
            {% endfor %}
            </ul>
        </div>
    </div>
    <div class="profile-listings">
        <hr>
    </div>
    {% endif %}

        {% if user == current_user %}
            <h2>My Active Listings</h2>
        {% else %}
            <h2>{{ user.username }}'s Active Listings</h2>
        {% endif %}
        
        {% if user_active_listings_count == 0 %}
            <div class="center-container">
                <p class="no-listings">No active listings. <a href="{% url 'create' %}">Want to change that?</a></p>
            </div>
        {% else %}
            <div class="profile-listings">
                {% if user.listings.all.count == 0 %}
                    <div class="center-container">
                        <p>No active listings. <a href="{% url 'create' %}">Want to change that?</a></p>
                    </div>
                {% endif %}
                <ul class="no-list-style-center">
                    {% for listing in user.listings.all %}
                        {% if listing.active == True %}
                            <li class="li-listing">  
                                <a class="bold" href="{% url 'listing' listing.id %}">{{ listing.title }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
                <hr style="margin-top:30px;">
            </div>  
        {% endif %}

    
    {% if user == current_user %}
        <h2>My Closed Listings</h2>
    {% else %}
        <h2>{{ user.username }}'s Closed Listings</h2>
    {% endif %}

    {% if user_inactive_listings_count == 0 %}
        <div class="center-container">
            <p class="no-listings">No closed listings.</p>
        </div>
    {% else %}
        <div id="profile-closed-listings" class="profile-listings">
            <ul class="thin-list">
                {% for listing in user.listings.all %}
                    {% if listing.active == False %}
                        <li class="li-listing">
                                <a class="bold" href="{% url 'listing' listing.id %}">{{ listing.title }}</a>
                        </li>
                        {% if listing.price == listing.starting_bid %}
                            <p style="display:inline" class="bold">No bids</p>
                        {% else %}
                        <p style="display:inline"><span class="bold">Final Bid:</span> {% with formatted_currency=listing.price|format_currency %}{{ formatted_currency }}{% endwith %}</br>
                                {% if listing.winner %}
                                    <span class="bold">Winner:</span> {{ listing.winner.username }}
                                {% else %}
                                    No winner
                                {% endif %}
                        </p>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    {% endif %}
</div>
<div class="divider-med"></div>
<div class="center-container">
    <p>See Dangerous Options</p>
<div class="delete-account-div">

    </div>
</div>
<div class="divider-small"></div>
<script>
    // Set the localStorage value of the transactionsPageSection. Used on transactions page to determine 
    // which section to scroll into view
    const transactionHistoryLink = document.getElementById('transaction-history-link');
    const bidHistoryLink = document.getElementById('bid-history-link');

    if (transactionHistoryLink) {
        transactionHistoryLink.addEventListener('click', () => {
            localStorage.setItem('transactionsPageSection', 'transactions');
        });
    }

    if (bidHistoryLink) {
        bidHistoryLink.addEventListener('click', () => {
            localStorage.setItem('transactionsPageSection', 'bids');
        });
    }

    const sendMsgButton = document.getElementById('send-usr-msg-btn');
    const sendMsgForm = document.getElementById('send-usr-msg-form');
    const cancelMsg = document.getElementById('cancel-usr-msg');

    if (sendMsgButton) {
        sendMsgButton.addEventListener('click', () => {
        sendMsgForm.classList.remove('hidden');
        sendMsgForm.classList.add('visible');
    });

        cancelMsg.addEventListener('click', () => {
        sendMsgForm.classList.add('hidden');
        sendMsgForm.classList.remove('visible');
    });
    }



    const depositButton = document.getElementById('deposit-btn');
    const depositForm = document.querySelector('.deposit-form');
    const cancelDeposit = document.getElementById('cancel-deposit-btn');

    const withdrawButton = document.getElementById('withdraw-btn');
    const withdrawForm = document.querySelector('.withdraw-form');
    const cancelWithdraw = document.getElementById('cancel-withdraw-btn');

    const editButton = document.getElementById('edit-button');
    const editProfile = document.getElementById('edit-profile');
    const cancelButton = document.getElementById('cancel-edit-profile-button');

    const changePassword = document.getElementById('change-password');
    const changePasswordForm = document.getElementById('change-password-form');
    const cancelPassword = document.getElementById('cancel-password-btn');

    if (depositButton) {
        depositButton.addEventListener('click', () => {
            depositForm.classList.remove('hidden');
            depositForm.classList.add('visible');
        });

        cancelDeposit.addEventListener('click', () => {
            depositForm.classList.add('hidden');
            depositForm.classList.remove('visible');
        });

        withdrawButton.addEventListener('click', () => {
            withdrawForm.classList.remove('hidden');
            withdrawForm.classList.add('visible');
        });

        cancelWithdraw.addEventListener('click', () => {
            withdrawForm.classList.add('hidden');
            withdrawForm.classList.remove('visible');
        });

        editButton.addEventListener('click', () => {
            editProfile.classList.remove('hidden');
            editProfile.classList.add('visible');
        });

        cancelButton.addEventListener('click', () => {
            editProfile.classList.add('hidden');
            editProfile.classList.remove('visible');
        });


        changePassword.addEventListener('click', () => {
            changePasswordForm.classList.remove('hidden');
            changePasswordForm.classList.add('visible');
        });

        cancelPassword.addEventListener('click', () => {
            changePasswordForm.classList.add('hidden');
            changePasswordForm.classList.remove('visible');
        });
    }











</script>

{% endblock %}