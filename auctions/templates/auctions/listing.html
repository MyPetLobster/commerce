{% extends "auctions/layout.html" %}

{% load tz %}

{% block title %}
    Listing: {{ listing.title }}
{% endblock %}

{% block navbar %}
    <li class="nav-item">
        <a class="nav-link" href="{% url 'index' %}">Active Listings</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'listings' %}">All Listings</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'create' %}">Create Listing</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'watchlist' %}">Watchlist</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'categories' %}">All Categories</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'profile' user.id %}">My Yard</a>
    </li>
{% endblock %}

{% block body %}

<div class="page-content">
    <h2 class="page-heading-h2">{{ listing.title }}</h2>

    {% if listing.image != "" %}
        <img src="{{ listing.image }}" height="450">
    {% endif %}
    <div class="listing-desc">
        <p><span class="bold">Created by:&nbsp;&nbsp;</span><span class="lightweight">{{ listing.user.username }}</span></br>
            <span class="bold">Current Bid:&nbsp;&nbsp;</span><span class="lightweight">${{ listing.price }}</span></br> 
            {% if user_bid != None %}
                {% if user_bid.amount == listing.price %}
                    <span class="bold">Your Bid:&nbsp;&nbsp;</span><span class="lightweight" style="color: green">${{ user_bid.amount }} (You are the current highest bidder!)</span></br>
                {% else %}
                    <span class="bold">Your Bid:&nbsp;&nbsp;</span><span class="lightweight" style="color: red">${{ user_bid.amount }} (Your bid is ${{ difference }} less than the current highest bid)</span></br>
                {% endif %} 
            {% endif %}
            <span class="bold">Time Left:&nbsp;&nbsp;</span><span id="countdown" class="lightweight"></span></br>
            <span class="bold">Description:&nbsp;&nbsp;</span><span class="lightweight">{{ listing.description }}</span></br>
        {% if listing.categories %}
            <span class="bold">Categories:</span> 
            {% for category in listing.categories.all %}
                <a href="{% url 'category' category.id %}">{{ category.category }}</a> 
            {% endfor %}
        {% endif %}
        </p>
    </div>
    {% if user.is_authenticated %}
        {% if listing.active == True %}

            <form action="/add_to_watchlist/{{ listing.id }}" method="post">
                {% csrf_token %}
                <button class="btn btn-primary" type="submit">Add to Watchlist</button>
            </form>
            <p></p>

            {% if listing.user != user %}
                <form class="bid-form" action="/listing/{{ listing.id }}" method="post">
                    {% csrf_token %}
                    <input class="form-control" type="number" name="amount" step="0.01" min="{{ listing.price }}">
                    <button class="btn btn-primary" type="submit">Place Bid</button>
                </form>
            {% endif %}

            {% if listing.user == user %}
                <form action="/close_listing/{{ listing.id }}" method="post">
                    {% csrf_token %}
                    <button id="close-listing-btn" class="btn btn-primary" type="submit">Close Listing</button>
                </form>
            {% endif %}

        {% else %}
        <div class="bidding-closed">
            -- BIDDING CLOSED -- </br>
            {% if winner.user == user %}
                You Won! (See email for details on how to proceed.)
            {% elif listing.price == listing.starting_bid %}
                No Bids
            {% else %}
                Winner: {{ winner.user.username }}
            {% endif %}
        </div>
        {% endif %}
        
        <div class="comments-div">
            <h2>Comments</h2>

            {% if listing.active == True %}
                <button class="btn btn-primary" id="comment-button">Leave a Comment</button>
                <form id="comment-form" class="hidden-form popup-form" action="/comment/{{ listing.id }}" method="post">
                    {% csrf_token %}
                    {{ comment_form }}
                    <div class="center-container">
                        <button class="btn btn-primary" type="submit">Submit</button>
                        <button class="btn btn-primary" type="button" id="cancel-comment">Cancel</button>
                    </div>
                </form>
            {% endif %}

            
            <ul>
                {% for comment in comments %}
                    {% if comment.anonymous == True %}
                    <li><span class="bold">Anonymous:</span> {{ comment.comment }}</br><span class="timestamp lightweight">{{ comment.date }}</span></li>
                    {% else %}
                    <li><span class="bold">{{ comment.user.username }}:</span> {{ comment.comment }}</br><span class="timestamp lightweight">{{ comment.date }}</span></li>
                    {% endif %}
                    
                {% endfor %}
            </ul>
        </div>
    {% endif %}
</div>

<script>

    const commentButton = document.querySelector('#comment-button');
    const commentForm = document.querySelector('#comment-form');
    const cancelComment = document.querySelector('#cancel-comment');

    document.addEventListener('DOMContentLoaded', function() {
        commentButton.onclick = function() {
            commentForm.classList.remove('hidden-form');
            commentForm.classList.add('visible-form');
        }
        cancelComment.onclick = function() {
            commentForm.classList.remove('visible-form');
            commentForm.classList.add('hidden-form');
        }
    });

    // Function to update the countdown
    function updateCountdown() {
        // Get the countdown element
        var countdownElement = document.getElementById('countdown');

        // Get the time left from the Django variable
        var timeLeft = "{{ time_left }}";

        // Split the time left into hours, minutes, and seconds
        var timeParts = timeLeft.split(', ');

        // Convert hours, minutes, and seconds to milliseconds
        var millisecondsLeft = parseInt(timeParts[0]) * 60 * 60 * 1000 + parseInt(timeParts[1]) * 60 * 1000 + parseInt(timeParts[2]) * 1000;

        // Update the countdown every second
        var countdownInterval = setInterval(function() {
            // Subtract one second from the remaining time
            millisecondsLeft -= 1000;

            // Check if the remaining time is less than 0
            if (millisecondsLeft <= 0) {
                // If the time has expired, clear the interval
                clearInterval(countdownInterval);
                // Set the countdown text to "Expired"
                countdownElement.textContent = "Expired";
            } else {
                // Convert milliseconds to hours, minutes, and seconds
                var hours = Math.floor(millisecondsLeft / (1000 * 60 * 60));
                var minutes = Math.floor((millisecondsLeft % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((millisecondsLeft % (1000 * 60)) / 1000);

                // Format the remaining time
                var formattedTime = hours + " hours, " + minutes + " minutes, " + seconds + " seconds";

                // Update the countdown text
                countdownElement.textContent = formattedTime;

                // Check if the remaining time is less than 1 hour, 12 hours, or 24 hours
                if (hours < 1) {
                    countdownElement.style.color = "red";
                } else if (hours < 12) {
                    countdownElement.style.color = "orange";
                } else if (hours < 24) {
                    countdownElement.style.color = "yellow";
                } 
            }
        }, 1000); // Update every second
    }

    // Call the updateCountdown function when the page loads
    window.onload = updateCountdown;
</script>
{% endblock %}