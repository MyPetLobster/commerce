{% extends "auctions/layout.html" %}

{% block title %}
    Listing: {{ listing.title }}
{% endblock %}

{% block navbar %}
    <li class="nav-item">
        <a class="nav-link" href="{% url 'index' %}">Active Listings</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'listings' %}">All Listings</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'create' %}">Create Listing</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'watchlist' %}">Watchlist</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'categories' %}">All Categories</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'profile' user.id %}">My Yard</a>
    </li>
{% endblock %}

{% block body %}
<div class="page-content">
    <h2 class="page-heading-h2">{{ listing.title }}</h2>

    {% if listing.image != "" %}
        <img src="{{ listing.image }}" height="450">
    {% endif %}
    <div class="listing-desc">
        <p><span class="bold">Created by:</span> {{ listing.user.username }}</br>
        <span class="bold">Current Bid:</span> {{ listing.price }}</br>    
        <span class="bold">Time Left:</span> {{ time_left }}</br>
        <span class="bold">Description:</span> {{ listing.description }}</br>
        
        {% if listing.categories %}
            <span class="bold">Categories:</span> 
            {% for category in listing.categories.all %}
                {{ category.category }}
            {% endfor %}
        {% endif %}
        </p>
    </div>
    {% if user.is_authenticated %}
        {% if listing.active == True %}

            <form action="/add_to_watchlist/{{ listing.id }}" method="post">
                {% csrf_token %}
                <button class="btn btn-primary" type="submit">Add to Watchlist</button>
            </form>
            <p></p>

            {% if listing.user != user %}
                <form class="bid-form" action="/listing/{{ listing.id }}" method="post">
                    {% csrf_token %}
                    <input class="form-control" type="number" name="amount" step="0.01" min="{{ listing.price }}">
                    <button class="btn btn-primary" type="submit">Place Bid</button>
                </form>
            {% endif %}

            {% if listing.user == user %}
                <form action="/close_listing/{{ listing.id }}" method="post">
                    {% csrf_token %}
                    <input type="submit" value="Close Listing">
                </form>
            {% endif %}

        {% else %}
            -- BIDDING CLOSED -- </br>
            {% if winner.user == user %}
                You Won! (See email for details on how to proceed.)
            {% else %}
                Winner: {{ winner.user.username }}
            {% endif %}
        {% endif %}
        
        <div class="comments-div">
            <h2>Comments</h2>

            {% if listing.active == True %}
                <button class="btn btn-primary" id="comment-button">Leave a Comment</button>
                <form id="comment-form" class="hidden-form" action="/comment/{{ listing.id }}" method="post">
                    {% csrf_token %}
                    {{ comment_form }}
                    <input type="submit" value="Submit">
                    <button type="button" id="cancel-comment">Cancel</button>
                </form>
            {% endif %}

            
            <ul>
                {% for comment in comments %}
                    {% if comment.anonymous == True %}
                    <li>Anonymous: {{ comment.comment }}</li>
                    {% else %}
                    <li>{{ comment.user.username }}: {{ comment.comment }}</li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    {% endif %}
</div>

<script>

    const commentButton = document.querySelector('#comment-button');
    const commentForm = document.querySelector('#comment-form');
    const cancelComment = document.querySelector('#cancel-comment');

    document.addEventListener('DOMContentLoaded', function() {
        commentButton.onclick = function() {
            commentForm.classList.remove('hidden-form');
            commentForm.classList.add('visible-form');
        }
        cancelComment.onclick = function() {
            commentForm.classList.remove('visible-form');
            commentForm.classList.add('hidden-form');
        }
    });
</script>
{% endblock %}